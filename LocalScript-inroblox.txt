-- Final Stable LocalScript v4 (The "Remington UI" Edition)
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TweenService = game:GetService("TweenService")
local MasterVoiceEvent = ReplicatedStorage:WaitForChild("MasterVoiceEvent")

-- HIERARCHY FIX: Assuming Script and Label are siblings under the ScreenGui
local label = script.Parent:WaitForChild("DialogueLabel") 

-- CONFIGURATION
local TYPE_SPEED = 0.04 
local REMINGTON_ID = "rbxassetid://9120300060" 

-- Setup Audio Instance
local beep = Instance.new("Sound", label)
beep.SoundId = REMINGTON_ID
beep.Volume = 0.3
beep.Name = "TypewriterSound"

local isTyping = false

-- 1. THE LAYOUT FIX: Force the UI to stay in the correct position
local function setupLayout()
	label.AnchorPoint = Vector2.new(0.5, 1) -- Pivot at bottom center
	label.Position = UDim2.new(0.5, 0, 0.85, 0) -- 15% from bottom
	label.Size = UDim2.new(0, 600, 0, 150) -- Massive breathing room
	label.ZIndex = 10
	label.TextWrapped = true
	label.TextXAlignment = Enum.TextXAlignment.Center
	label.TextYAlignment = Enum.TextYAlignment.Center
	label.Visible = false
end

setupLayout() -- Initialize on start

local function playClick()
	pcall(function()
		beep.PlaybackSpeed = math.random(85, 115) / 100 
		beep:Play()
	end)
end

local function applyTheme(zone)
	if zone == "Western_Town" then
		label.Font = Enum.Font.SpecialElite
		label.TextColor3 = Color3.fromRGB(200, 150, 50)
		label.BackgroundColor3 = Color3.fromRGB(40, 20, 10)
	elseif zone == "Haunted_Mansion" then
		label.Font = Enum.Font.Fantasy 
		label.TextColor3 = Color3.fromRGB(150, 0, 255)
		label.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
	else
		-- Default Cyberpunk (Angkor Wat)
		label.Font = Enum.Font.RobotoMono
		label.TextColor3 = Color3.fromRGB(0, 255, 255)
		label.BackgroundColor3 = Color3.fromRGB(10, 10, 20)
	end
	label.RichText = true
end

local function typewriter(fullText, zone)
	isTyping = true
	applyTheme(zone)

	-- RESET STATE
	label.Text = ""
	label.Visible = true
	label.TextTransparency = 0
	label.BackgroundTransparency = 0.3

	-- DYNAMIC FONT RESIZING
	if #fullText > 150 then
		label.TextSize = 16
	else
		label.TextSize = 22
	end

	-- Reveal text character by character
	for i = 1, #fullText do
		if not isTyping then break end

		label.Text = string.sub(fullText, 1, i)

		if string.sub(fullText, i, i) ~= " " then
			playClick()
		end

		task.wait(TYPE_SPEED) 
	end

	task.wait(6) -- Long read time for immersion

	-- Fade out UI
	local fade = TweenService:Create(label, TweenInfo.new(1.5), {
		TextTransparency = 1, 
		BackgroundTransparency = 1
	})
	fade:Play()
	fade.Completed:Connect(function()
		if not isTyping then label.Visible = false end
	end)

	isTyping = false
end

MasterVoiceEvent.OnClientEvent:Connect(function(message, zone)
	isTyping = false
	task.wait(0.1) 
	task.spawn(function()
		typewriter(message, zone)
	end)
end)
